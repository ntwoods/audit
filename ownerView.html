<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Audit — Owner View</title>

  <!-- Favicon -->
  <link rel="icon" href="logo.png" type="image/png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="luxon.js" defer></script>  

    <!-- Tabulator (table library) -->
  <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>


  <!-- flatpickr (date picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; background: #f9fafb; color: #111827; }
    .status-pill { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-noerror { background:#dcfce7; color:#065f46; }
    .status-tally { background:#fee2e2; color:#991b1b; }
    .btn { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .65rem; border-radius:.5rem; border:1px solid #e5e7eb; background:#fff; font-size:.8rem; transition: all .2s; }
    .btn:hover { background:#f3f4f6; }
    .toolbar { position: sticky; top: 0; z-index: 30; backdrop-filter: blur(6px); background: rgba(255,255,255,.9); }
    .loading { text-align:center; padding:2rem; color:#6b7280; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="toolbar border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Inventory Audit — Owner View</h1>
        <p class="text-sm text-slate-500">Audit data overview with filters, sorting & file access</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span id="stat-total" class="px-3 py-1 rounded-lg bg-slate-100 text-slate-700 text-sm">Total: 0</span>
        <span id="stat-ok" class="px-3 py-1 rounded-lg bg-green-100 text-green-700 text-sm">No Error: 0</span>
        <span id="stat-red" class="px-3 py-1 rounded-lg bg-rose-100 text-rose-700 text-sm">Tally Adj.: 0</span>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <section class="max-w-7xl mx-auto px-4 mt-4 mb-2">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Date Quick Filter</label>
        <select id="quickDate" class="w-full rounded-lg border-slate-300 text-sm">
          <option value="all">All Dates</option>
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="thisWeek">This Week</option>
          <option value="lastWeek">Last Week</option>
          <option value="last10">Last 10 Days</option>
          <option value="last20">Last 20 Days</option>
          <option value="last30">Last 30 Days</option>
          <option value="thisMonth">This Month</option>
          <option value="range">Custom Range…</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Custom Date Range</label>
        <input id="dateRange" class="w-full rounded-lg border-slate-300 text-sm" placeholder="Select range" disabled>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Category</label>
        <select id="categoryFilter" class="w-full rounded-lg border-slate-300 text-sm">
          <option value="">All Categories</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Status</label>
        <select id="statusFilter" class="w-full rounded-lg border-slate-300 text-sm">
          <option value="">All Status</option>
          <option value="noerror">No Error</option>
          <option value="tallyadjustment">Tally Adjustment</option>
        </select>
      </div>
    </div>
    <div class="mt-3 flex flex-wrap gap-2">
      <button id="btnReset" class="btn">Reset Filters</button>
      <button id="btnRefresh" class="btn">Refresh Data</button>
      <button id="btnDownloadCSV" class="btn">Download CSV</button>
    </div>
  </section>

  <!-- Table -->
  <main class="max-w-7xl mx-auto px-4 pb-12">
    <div id="loading" class="loading">Loading data…</div>
    <div id="table" class="hidden border border-slate-200 rounded-xl bg-white shadow-sm"></div>
    <div id="emptyState" class="hidden mt-8 text-center text-slate-500">No records match the current filters.</div>
    <div id="errorState" class="hidden mt-8 text-center text-rose-600 font-medium">Couldn’t load data. Please check the API.</div>
  </main>

  <!-- Dashboard Script -->
  <script defer>
    // ===== Date helpers =====
    function parseISO(str){ return new Date(str); }
    function formatDate(d){ if(isNaN(d)) return ""; return d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}); }
    function startOfToday(){ const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
    function subDays(date,days){ const d=new Date(date); d.setDate(d.getDate()-days); return d; }
    function startOfWeek(date,{weekStartsOn=1}={}){ const d=new Date(date); const day=(d.getDay()+7-weekStartsOn)%7; d.setDate(d.getDate()-day); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
    function endOfWeek(date,{weekStartsOn=1}={}){ const start=startOfWeek(date,{weekStartsOn}); return new Date(start.getFullYear(),start.getMonth(),start.getDate()+6,23,59,59); }
    function startOfMonth(date){ return new Date(date.getFullYear(),date.getMonth(),1); }
    function endOfMonth(date){ return new Date(date.getFullYear(),date.getMonth()+1,0,23,59,59); }
    function isWithinInterval(d,{start,end}){ return d>=start && d<=end; }
    function isSameDay(d1,d2){ return d1.toDateString()===d2.toDateString(); }

    // ===== Globals =====
    const API_URL = "https://script.google.com/macros/s/AKfycbze820nXuy0s0RZNajlPzFq4AeyEaOhjp3IS_tqfi2RB7XKbzYvOi2nwXFUEUqtXh56/exec?action=ownerview";
    let rawData = [], table;
    const els = {
      table: document.getElementById('table'),
      loading: document.getElementById('loading'),
      empty: document.getElementById('emptyState'),
      error: document.getElementById('errorState'),
      statTotal: document.getElementById('stat-total'),
      statOk: document.getElementById('stat-ok'),
      statRed: document.getElementById('stat-red'),
      quickDate: document.getElementById('quickDate'),
      dateRange: document.getElementById('dateRange'),
      cat: document.getElementById('categoryFilter'),
      stat: document.getElementById('statusFilter'),
      btnReset: document.getElementById('btnReset'),
      btnRefresh: document.getElementById('btnRefresh'),
      btnCSV: document.getElementById('btnDownloadCSV')
    };

    function safeInit(){
      if (window.Tabulator) {
        init(); // run your real init only when Tabulator exists
      } else {
        console.log("Waiting for Tabulator...");
        setTimeout(safeInit, 50); // retry after 50ms
      }
    }
    document.addEventListener("DOMContentLoaded", safeInit);

    async function init(){
      await loadData();
      buildCategoryFilter();
      buildTable();
      wireControls();
      applyFilters();
    }

    // ===== Load Data =====
    async function loadData(){
      els.loading.classList.remove('hidden');
      els.table.classList.add('hidden');
      els.error.classList.add('hidden');
      try{
        const res=await fetch(API_URL);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const json=await res.json();
        rawData=(json?.data||[]).map(r=>({...r,_statusNorm:String(r.status||'').toLowerCase(),_dateObj:r.date?parseISO(r.date):null}));
        updateStats(rawData);
        els.loading.classList.add('hidden');
        els.table.classList.remove('hidden');
      }catch(e){
        console.error(e);
        els.loading.classList.add('hidden');
        els.error.classList.remove('hidden');
      }
    }

    function updateStats(arr){
      els.statTotal.textContent=`Total: ${arr.length}`;
      els.statOk.textContent=`No Error: ${arr.filter(x=>x._statusNorm==='noerror').length}`;
      els.statRed.textContent=`Tally Adj.: ${arr.filter(x=>x._statusNorm==='tallyadjustment').length}`;
    }

    // ===== Filters =====
    function buildCategoryFilter(){
      const cats=[...new Set(rawData.map(r=>r.category).filter(Boolean))].sort();
      els.cat.innerHTML=`<option value="">All Categories</option>`+cats.map(c=>`<option>${c}</option>`).join('');
    }

    function currentDateInterval(){
      const now=new Date();
      switch(els.quickDate.value){
        case "today": return {start:startOfToday(),end:now};
        case "yesterday": return {start:subDays(startOfToday(),1),end:startOfToday()};
        case "thisWeek": return {start:startOfWeek(now,{weekStartsOn:1}),end:endOfWeek(now,{weekStartsOn:1})};
        case "lastWeek": {const end=subDays(startOfWeek(now,{weekStartsOn:1}),1);return {start:startOfWeek(end,{weekStartsOn:1}),end};}
        case "last10": return {start:subDays(startOfToday(),9),end:now};
        case "last20": return {start:subDays(startOfToday(),19),end:now};
        case "last30": return {start:subDays(startOfToday(),29),end:now};
        case "thisMonth": return {start:startOfMonth(now),end:endOfMonth(now)};
        case "range": {
          const [start,end]=els.dateRange._flatpickr.selectedDates||[];
          if(start&&end) return {start,end};
          return null;
        }
        default: return null;
      }
    }

    function applyFilters(){
      if(!table) return;
      const cat=els.cat.value.trim().toLowerCase();
      const stat=els.stat.value.trim().toLowerCase();
      const interval=currentDateInterval();
      table.setFilter((d)=>{
        if(cat && String(d.category||'').toLowerCase()!==cat) return false;
        if(stat && String(d._statusNorm||'')!==stat) return false;
        if(interval){const date=d._dateObj;if(!date) return false;if(!isWithinInterval(date,interval)) return false;}
        return true;
      });
      els.empty.classList.toggle('hidden',table.getDataCount()>0);
    }

    // ===== Table =====
    function buildTable(){
      if(table) table.destroy();
      table=new Tabulator("#table",{
        data:rawData,
        layout:"fitColumns",
        height:"600px",
        initialSort:[{column:"date",dir:"desc"}],
        columns:[
          {title:"Date",field:"date",sorter:"date",formatter:(c)=>formatDate(parseISO(c.getValue()))},
          {title:"Category",field:"category"},
          {title:"Audit ID",field:"audit_id"},
          {title:"Status",field:"status",formatter:(c)=>{const v=(c.getValue()||'').toLowerCase();if(v==='noerror') return `<span class="status-pill status-noerror">No Error</span>`;if(v==='tallyadjustment') return `<span class="status-pill status-tally">Tally Adjustment</span>`;return v;}},
          {title:"Audit Remark",field:"audit_remark"},
          {title:"Audit File",field:"audit_file",formatter:(c)=>c.getValue()?`<a class="btn" href="${c.getValue()}" target="_blank">Open</a>`:""},
          {title:"Verification Remark",field:"verification_remark"},
          {title:"Verification File",field:"verification_file",formatter:(c)=>c.getValue()?`<a class="btn" href="${c.getValue()}" target="_blank">Open</a>`:""},
          {title:"Journal Entry Remark",field:"journal_entry_remark"},
          {title:"Journal Entry File",field:"journal_entry_file",formatter:(c)=>c.getValue()?`<a class="btn" href="${c.getValue()}" target="_blank">Open</a>`:""},
          {title:"Accounts Remark",field:"accountsremark"},
          {title:"Accounts Correction File",field:"accountscorrectionfile",formatter:(c)=>c.getValue()?`<a class="btn" href="${c.getValue()}" target="_blank">Open</a>`:""},
        ],
      });
    }

    // ===== Controls =====
    function wireControls(){
      els.quickDate.addEventListener('change',()=>{
        if(els.quickDate.value==="range"){els.dateRange.disabled=false;els.dateRange._flatpickr.open();}else{els.dateRange.disabled=true;els.dateRange._flatpickr.clear();}
        applyFilters();
      });
      els.cat.addEventListener('change',applyFilters);
      els.stat.addEventListener('change',applyFilters);
      els.btnReset.addEventListener('click',()=>{els.quickDate.value="all";els.dateRange._flatpickr.clear();els.dateRange.disabled=true;els.cat.value="";els.stat.value="";applyFilters();});
      els.btnRefresh.addEventListener('click',async()=>{await loadData();table.replaceData(rawData);buildCategoryFilter();applyFilters();});
      els.btnCSV.addEventListener('click',()=>table.download("csv","audits.csv"));
      // flatpickr init
      els.dateRange._flatpickr=flatpickr(els.dateRange,{mode:"range",dateFormat:"d M Y",onChange:applyFilters});
    }
  </script>
</body>
</html>
