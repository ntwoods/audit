<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Audit — Owner View</title>

  <!-- Favicon (fixes 404) -->
  <link rel="icon" href="logo.png" type="image/png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tabulator (table) -->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>



  <!-- flatpickr (date picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    .tabulator .tabulator-header .tabulator-col { background:#f8fafc; }
    .tabulator .tabulator-row:hover { background: #f1f5f9; }
    .status-pill { padding: 0.15rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-noerror { background:#dcfce7; color:#065f46; }
    .status-tally { background:#fee2e2; color:#991b1b; }
    .tabulator-row:nth-child(even) { background:#fafafa; }
    .btn { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .55rem; border-radius:.5rem; border:1px solid #e5e7eb; background:#fff; font-size:.8rem;}
    .btn:hover { background:#f8fafc; }
    .btn:focus { outline:2px solid #bfdbfe; outline-offset:2px; }
    .btn svg { width:14px; height:14px; }
    .toolbar { position: sticky; top: 0; z-index: 30; backdrop-filter: blur(6px); background: rgba(255,255,255,.8); }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="toolbar border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Inventory Audit — Owner View</h1>
        <p class="text-sm text-slate-500">Live overview of audit outcomes with quick filters & file access.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span id="stat-total" class="px-3 py-1 rounded-lg bg-slate-100 text-slate-700 text-sm">Total: 0</span>
        <span id="stat-ok" class="px-3 py-1 rounded-lg bg-green-100 text-green-700 text-sm">No Error: 0</span>
        <span id="stat-red" class="px-3 py-1 rounded-lg bg-rose-100 text-rose-700 text-sm">Tally Adj.: 0</span>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto px-4 mt-4 mb-2">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Date Quick Filter</label>
        <select id="quickDate" class="w-full rounded-lg border-slate-300 text-sm">
          <option value="all">All Dates</option>
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="thisWeek">This Week</option>
          <option value="lastWeek">Last Week</option>
          <option value="last10">Last 10 Days</option>
          <option value="last20">Last 20 Days</option>
          <option value="last30">Last 30 Days</option>
          <option value="thisMonth">This Month</option>
          <option value="range">Custom Range…</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Custom Date Range</label>
        <input id="dateRange" class="w-full rounded-lg border-slate-300 text-sm" placeholder="Select range" disabled>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Category</label>
        <select id="categoryFilter" class="w-full rounded-lg border-slate-300 text-sm">
          <option value="">All Categories</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Status</label>
        <select id="statusFilter" class="w-full rounded-lg border-slate-300 text-sm">
          <option value="">All Status</option>
          <option value="noerror">No Error</option>
          <option value="tallyadjustment">Tally Adjustment</option>
        </select>
      </div>
    </div>
    <div class="mt-3 flex flex-wrap gap-2">
      <button id="btnReset" class="btn">Reset Filters</button>
      <button id="btnRefresh" class="btn">Refresh Data</button>
      <button id="btnDownloadCSV" class="btn">Download CSV</button>
    </div>
  </section>

  <!-- Table -->
  <main class="max-w-7xl mx-auto px-4 pb-12">
    <div id="table" class="border border-slate-200 rounded-xl bg-white shadow-sm"></div>
    <div id="emptyState" class="hidden mt-8 text-center text-slate-500">No records match the current filters.</div>
    <div id="errorState" class="hidden mt-8 text-center text-rose-600 font-medium">Couldn’t load data. Please check the API or try again.</div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbze820nXuy0s0RZNajlPzFq4AeyEaOhjp3IS_tqfi2RB7XKbzYvOi2nwXFUEUqtXh56/exec?action=ownerview";

    let rawData = [];
    let table;

    const statTotal = document.getElementById('stat-total');
    const statOk = document.getElementById('stat-ok');
    const statRed = document.getElementById('stat-red');
    const quickDate = document.getElementById('quickDate');
    const dateRange = document.getElementById('dateRange');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const btnReset = document.getElementById('btnReset');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnDownloadCSV = document.getElementById('btnDownloadCSV');
    const emptyState = document.getElementById('emptyState');
    const errorState = document.getElementById('errorState');

    let datePicker = flatpickr(dateRange, { mode: "range", dateFormat: "d M Y", onChange: applyFilters });

    init();

    async function init() {
      await loadData();
      buildCategoryFilter();
      buildTable();
      wireControls();
      applyFilters();
    }

function parseISO(str) {
  return new Date(str);
}

function formatDate(date, fmt = "dd MMM yyyy") {
  if (!(date instanceof Date) || isNaN(date)) return "";
  const day = String(date.getDate()).padStart(2, "0");
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const month = monthNames[date.getMonth()];
  const year = date.getFullYear();
  return `${day} ${month} ${year}`;
}

function startOfToday() {
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function subDays(date, days) {
  const d = new Date(date);
  d.setDate(d.getDate() - days);
  return d;
}

function startOfWeek(date, weekStartsOn = 1) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day < weekStartsOn ? 7 : 0) + day - weekStartsOn;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate() - diff);
}

function endOfWeek(date, weekStartsOn = 1) {
  const start = startOfWeek(date, weekStartsOn);
  return new Date(start.getFullYear(), start.getMonth(), start.getDate() + 6, 23, 59, 59);
}

function startOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function endOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59);
}

function isWithinInterval(d, {start, end}) {
  return d >= start && d <= end;
}

function isSameDay(d1, d2) {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
}

    
    async function loadData() {
      errorState.classList.add('hidden');
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        rawData = (json && json.data ? json.data : []).map(r => ({
          ...r,
          _statusNorm: String(r.status || '').toLowerCase(),
          _dateObj: r.date ? parseISO(r.date) : null,
        }));
        updateStats(rawData);
      } catch (e) {
        console.error(e);
        errorState.classList.remove('hidden');
      }
    }

    function updateStats(arr) {
      statTotal.textContent = `Total: ${arr.length}`;
      statOk.textContent = `No Error: ${arr.filter(x => x._statusNorm === 'noerror').length}`;
      statRed.textContent = `Tally Adj.: ${arr.filter(x => x._statusNorm === 'tallyadjustment').length}`;
    }

    function buildCategoryFilter() {
      const cats = Array.from(new Set(rawData.map(r => r.category).filter(Boolean))).sort();
      categoryFilter.innerHTML = `<option value="">All Categories</option>` + cats.map(c => `<option>${c}</option>`).join('');
    }

    function buildTable() {
      if (table) table.destroy();
      table = new Tabulator("#table", {
        data: rawData,
        layout: "fitColumns",
        height: "600px",
        initialSort: [{ column:"date", dir:"desc" }],
        placeholder: "Loading…",
        columns: [
          { title: "Date", field: "date", sorter: "date", width: 120, formatter: (cell) => formatDate(parseISO(cell.getValue()), "dd MMM yyyy") },
          { title: "Category", field: "category", widthGrow: 1 },
          { title: "Audit ID", field: "audit_id", width: 180 },
          { title: "Status", field: "status", width: 140, hozAlign:"center", formatter: (cell) => {
              const v = String(cell.getValue() || '').toLowerCase();
              if (v === 'noerror') return `<span class="status-pill status-noerror">No Error</span>`;
              if (v === 'tallyadjustment') return `<span class="status-pill status-tally">Tally Adjustment</span>`;
              return v;
            }
          },
          { title: "Audit Remark", field: "audit_remark", widthGrow: 1 },
          { title: "Audit File", field: "audit_file", formatter: (cell) => cell.getValue() ? `<a class="btn" href="${cell.getValue()}" target="_blank">Open</a>` : "" },
          { title: "Verification Remark", field: "verification_remark", widthGrow: 1 },
          { title: "Verification File", field: "verification_file", formatter: (cell) => cell.getValue() ? `<a class="btn" href="${cell.getValue()}" target="_blank">Open</a>` : "" },
          { title: "Journal Entry Remark", field: "journal_entry_remark", widthGrow: 1 },
          { title: "Journal Entry File", field: "journal_entry_file", formatter: (cell) => cell.getValue() ? `<a class="btn" href="${cell.getValue()}" target="_blank">Open</a>` : "" },
          { title: "Accounts Remark", field: "accountsremark", widthGrow: 1 },
          { title: "Accounts Correction File", field: "accountscorrectionfile", formatter: (cell) => cell.getValue() ? `<a class="btn" href="${cell.getValue()}" target="_blank">Open</a>` : "" },
        ],
      });
    }

    function wireControls() {
      quickDate.addEventListener('change', applyFilters);
      categoryFilter.addEventListener('change', applyFilters);
      statusFilter.addEventListener('change', applyFilters);
      btnReset.addEventListener('click', () => { quickDate.value="all"; datePicker.clear(); categoryFilter.value=""; statusFilter.value=""; applyFilters(); });
      btnRefresh.addEventListener('click', async () => { await loadData(); table.replaceData(rawData); buildCategoryFilter(); applyFilters(); });
      btnDownloadCSV.addEventListener('click', () => table.download("csv", "owner-audits.csv"));
    }

    function currentDateInterval() {
      const now = new Date();
      switch (quickDate.value) {
        case "today": return { start: startOfToday(), end: now };
        case "yesterday": return { start: subDays(startOfToday(),1), end: startOfToday() };
        case "thisWeek": return { start: startOfWeek(now,{weekStartsOn:1}), end: endOfWeek(now,{weekStartsOn:1}) };
        case "lastWeek": { const end=subDays(startOfWeek(now,{weekStartsOn:1}),1); return { start:startOfWeek(end,{weekStartsOn:1}), end }; }
        case "last10": return { start: subDays(startOfToday(),9), end: now };
        case "last20": return { start: subDays(startOfToday(),19), end: now };
        case "last30": return { start: subDays(startOfToday(),29), end: now };
        case "thisMonth": return { start: startOfMonth(now), end: endOfMonth(now) };
        default: return null;
      }
    }

    function applyFilters() {
      if (!table) return;
      const cat = categoryFilter.value.trim().toLowerCase();
      const stat = statusFilter.value.trim().toLowerCase();
      const interval = currentDateInterval();
      table.setFilter((data) => {
        if (cat && String(data.category || '').toLowerCase() !== cat) return false;
        if (stat && String(data._statusNorm || '') !== stat) return false;
        if (interval) {
          const d = data._dateObj;
          if (!d) return false;
          if (!isWithinInterval(d, interval)) return false;
        }
        return true;
      });
      emptyState.classList.toggle('hidden', table.getDataCount() > 0);
    }
  </script>
</body>
</html>
