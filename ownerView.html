<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Audit Management Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue-50:#f5f9ff;
      --blue-100:#e8f0ff;
      --blue-200:#d6e4ff;
      --blue-400:#5b8def;
      --blue-600:#2f5fd7;
      --blue-800:#1d3f96;
      --text:#0b1b2b;
      --muted:#4b5b70;
      --white:#fff;
      --shadow: 0 6px 24px rgba(26,60,114,0.08), 0 2px 8px rgba(26,60,114,0.08);
      --radius: 14px;
    }

    * { box-sizing:border-box }
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg,var(--blue-50), #ffffff 40%);
      color:var(--text);
    }
    .wrap { max-width:1200px; margin:0 auto; padding:24px 16px 48px; }
    .header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px; gap:16px; }
    .title { display:flex; align-items:center; gap:12px; }
    .logo {
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg,var(--blue-600),var(--blue-400));
      display:grid;place-items:center;color:#fff;font-weight:700;box-shadow: var(--shadow);
    }
    h1 { font-size:22px;margin:0;color:var(--blue-800); }
    .sub { margin:0;color:var(--muted);font-size:13px; }

    .panel {
      background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:16px; border:1px solid var(--blue-100);
    }

    .filters { display:grid; grid-template-columns: repeat(6, minmax(120px,1fr)); gap:10px; }
    @media (max-width: 980px){ .filters{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .filters{ grid-template-columns: 1fr;} }
    label{ font-size:12px;color:var(--muted);margin:4px 0 6px 2px;display:block; }
    select, input[type="date"] {
      width:100%; padding:10px 12px; border:1px solid var(--blue-200); border-radius:10px;
      background:#fff; outline:none;
    }
    select:focus,input[type="date"]:focus {
      border-color:var(--blue-600); box-shadow:0 0 0 3px rgba(47,95,215,0.15);
    }
    .btns{ display:flex; gap:10px; align-items:end; }
    .btn {
      border:0; padding:10px 14px; border-radius:10px;
      font-weight:600; cursor:pointer; white-space:nowrap;
      background:var(--blue-600); color:#fff; box-shadow:var(--shadow);
    }
    .btn.secondary{ background:#fff;color:var(--blue-800);border:1px solid var(--blue-200); }
    .btn.ghost{ background:transparent;color:var(--blue-800);border:1px dashed var(--blue-400);}
    .table-card { background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--blue-100); }
    table { width:100%; border-collapse:collapse; }
    thead { background:linear-gradient(180deg,#f7faff 0%, #f0f5ff 100%); }
    th, td { padding:8px 12px; border-bottom:1px solid #eaf0ff; text-align:left; font-size:14px; }
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;}

    /* === New status-based row colors === */
    .row-pending { background:#ffe6e6; }          /* Red */
    .row-green { background:#e6ffe6; }            /* Green */
    .row-yellow { background:#fffacc; }           /* Yellow */

    .foot{display:flex;justify-content:space-between;padding:8px 12px;font-size:12px;color:var(--muted);}
    .error{background:#fff1f2;border:1px solid #fecdd3;color:#b91c1c;padding:10px 12px;border-radius:10px;margin-top:10px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">
      <div class="logo">AM</div>
      <div>
        <h1>Audit Management — Glance Dashboard</h1>
        <p class="sub">IST times • Live filters • CSV export</p>
      </div>
    </div>
    <div class="btns">
      <button id="refreshBtn" class="btn secondary">Refresh</button>
      <button id="downloadBtn" class="btn">Download CSV</button>
    </div>
  </div>

  <div class="panel">
    <div class="filters">
      <div>
        <label for="categoryFilter">Category</label>
        <select id="categoryFilter"><option value="">All</option></select>
      </div>
      <div>
        <label for="statusFilter">Status</label>
        <select id="statusFilter"><option value="">All</option></select>
      </div>
      <div>
        <label for="dateFrom">Date From</label>
        <input type="date" id="dateFrom" />
      </div>
      <div>
        <label for="dateTo">Date To</label>
        <input type="date" id="dateTo" />
      </div>
      <div class="btns">
        <button id="applyFilters" class="btn">Apply</button>
        <button id="clearFilters" class="btn ghost">Clear</button>
      </div>
    </div>
    <div id="errorBox" class="error" style="display:none;"></div>
  </div>

  <div class="table-card">
    <table id="auditTable">
      <thead>
        <tr>
          <th>Date</th><th>Category</th><th>Status</th><th>Audit Date & Time</th><th>Ac Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="foot">
      <span id="rowCount">Rows: 0</span>
      <span id="lastUpdated">Last updated: —</span>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbze820nXuy0s0RZNajlPzFq4AeyEaOhjp3IS_tqfi2RB7XKbzYvOi2nwXFUEUqtXh56/exec?action=ownerview";

let rawRows = [];

function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return "";
  return d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"});
}
function fmtDateTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return "";
  return d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"})+" "+
         d.toLocaleTimeString("en-GB",{hour12:false});
}

/* Decide row color class based on status */
function getRowClass(status){
  if(!status) return "";
  const k = status.toLowerCase();
  if(k.includes("pending")) return "row-pending";
  if(["noerror","verifynoerror","tallyadjustment"].includes(k)) return "row-green";
  if(["error","verifyerror","journalentry","verifyjournalentry"].includes(k)) return "row-yellow";
  return "";
}

function renderTable(rows){
  const tbody = document.querySelector("#auditTable tbody");
  tbody.innerHTML = rows.map(r=>{
    return `<tr class="${getRowClass(r.status)}">
      <td>${fmtDate(r.date)}</td>
      <td>${r.category||""}</td>
      <td><span class="badge">${r.status||"-"}</span></td>
      <td>${fmtDateTime(r.audittimestamp)}</td>
      <td>${fmtDateTime(r.accountssettlementtimestamp)}</td>
    </tr>`;
  }).join("");
  document.getElementById("rowCount").textContent = "Rows: "+rows.length;
}

function populateFilters(rows){
  const cats = [...new Set(rows.map(r=>r.category).filter(Boolean))].sort();
  const stats = [...new Set(rows.map(r=>r.status).filter(Boolean))].sort();
  document.getElementById("categoryFilter").innerHTML = "<option value=''>All</option>"+cats.map(c=>`<option>${c}</option>`).join("");
  document.getElementById("statusFilter").innerHTML = "<option value=''>All</option>"+stats.map(s=>`<option>${s}</option>`).join("");
}

function applyFilters(){
  let filtered = [...rawRows];
  const cat = document.getElementById("categoryFilter").value;
  const stat = document.getElementById("statusFilter").value;
  const df = document.getElementById("dateFrom").value;
  const dt = document.getElementById("dateTo").value;
  if(cat) filtered = filtered.filter(r=>r.category===cat);
  if(stat) filtered = filtered.filter(r=>r.status===stat);
  if(df){
    const from = new Date(df+"T00:00:00");
    filtered = filtered.filter(r=>new Date(r.date)>=from);
  }
  if(dt){
    const to = new Date(dt+"T23:59:59");
    filtered = filtered.filter(r=>new Date(r.date)<=to);
  }
  renderTable(filtered);
}

function clearFilters(){
  document.getElementById("categoryFilter").value="";
  document.getElementById("statusFilter").value="";
  document.getElementById("dateFrom").value="";
  document.getElementById("dateTo").value="";
  renderTable(rawRows);
}

function downloadCSV(){
  const rows = Array.from(document.querySelectorAll("#auditTable tbody tr")).map(tr=> 
    Array.from(tr.children).map(td=>td.innerText)
  );
  let csv = "Date,Category,Status,Audit Date & Time,Ac Timestamp\n";
  rows.forEach(r=>{ csv += r.map(x=>`"${x}"`).join(",")+"\n"; });
  const blob = new Blob([csv],{type:"text/csv"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "audit_data_"+Date.now()+".csv";
  link.click();
}

async function fetchData(){
  showError("");
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    if(!json.success || !Array.isArray(json.data)) throw new Error("Invalid API Response");
    rawRows = json.data;
    renderTable(rawRows);
    populateFilters(rawRows);
    document.getElementById("lastUpdated").textContent = "Last updated: "+fmtDateTime(new Date().toISOString());
  }catch(err){
    showError("Failed to fetch data. "+err.message);
    console.error(err);
  }
}

function showError(msg){
  const box = document.getElementById("errorBox");
  if(!msg){ box.style.display="none"; box.textContent=""; }
  else{ box.style.display="block"; box.textContent=msg; }
}

document.getElementById("refreshBtn").addEventListener("click", fetchData);
document.getElementById("downloadBtn").addEventListener("click", downloadCSV);
document.getElementById("applyFilters").addEventListener("click", applyFilters);
document.getElementById("clearFilters").addEventListener("click", clearFilters);

document.addEventListener("DOMContentLoaded", fetchData);
</script>
</body>
</html>
