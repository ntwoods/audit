<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Start Audit - Pending</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f8fbff;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0b76ef;
      --accent-light: #e6f0ff;
      --accent-dark: #084c9b;
      --danger: #ef4444;
      --success: #10b981;
      --glass: rgba(0, 0, 0, 0.04);
    }

    body {
      margin: 0;
      font-family: 'Poppins', system-ui, sans-serif;
      background: linear-gradient(180deg, var(--bg), #fff);
      min-height: 100vh;
      padding: 24px;
      color: #111827;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    h1 {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
      color: var(--accent-dark);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px var(--glass);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge {
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
      background: var(--accent-light);
      color: var(--accent-dark);
      border: 1px solid #dbeafe;
    }

    .title {
      font-weight: 700;
      color: #1e293b;
      font-size: 16px;
    }

    .category {
      color: var(--muted);
      font-size: 14px;
    }

    .countdown {
      margin-top: 8px;
      font-weight: 700;
      font-size: 18px;
      color: red;
      text-shadow: 0 0 2px rgba(11, 118, 239, 0.2);
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: 0;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }
    button:hover {
      transform: translateY(-2px);
    }

    .err {
      background: var(--danger);
      color: #fff;
    }
    .err:hover {
      background: #dc2626;
    }

    .noerr {
      background: var(--accent);
      color: #fff;
    }
    .noerr:hover {
      background: var(--accent-dark);
    }

    .small {
      font-size: 13px;
      padding: 6px 12px;
    }

    .empty {
      padding: 40px;
      border-radius: 12px;
      background: var(--card);
      border: 1px dashed #d1d5db;
      text-align: center;
      color: var(--muted);
    }

    footer {
      margin-top: 16px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Start Audit — Pending</h1>
      <div style="color:var(--muted);font-size:13px;margin-top:4px">Fetches <strong>pending</strong> audits and allows reporting</div>
    </div>
    <div class="topbar">
      <button id="refreshBtn" class="small">Refresh</button>
    </div>
  </header>

  <main>
    <div id="cards" class="grid"></div>
    <div id="empty" class="empty" style="display:none;margin-top:12px">No pending audits found.</div>
  </main>

  <footer>
    Tip: actions are directly sent to the server.
  </footer>

  <script>
    (function(){
      const API_URL = 'https://script.google.com/macros/s/AKfycbze820nXuy0s0RZNajlPzFq4AeyEaOhjp3IS_tqfi2RB7XKbzYvOi2nwXFUEUqtXh56/exec';
      const cardsEl = document.getElementById('cards');
      const emptyEl = document.getElementById('empty');
      const refreshBtn = document.getElementById('refreshBtn');
      let timers = {};

      function fetchPending(){
        cardsEl.innerHTML = '';
        emptyEl.style.display = 'none';
        fetch(API_URL + '?action=pending').then(r=>r.json()).then(res=>{
          if(!res || !res.success || !Array.isArray(res.data) || res.data.length===0){
            emptyEl.style.display = 'block'; return;
          }
          buildCards(res.data);
            if (typeof setReadOnlyMode === "function") {
              setReadOnlyMode();
            }
        }).catch(err=>{
          emptyEl.textContent = 'Failed to fetch. Check API URL or deployment.'; 
          emptyEl.style.display = 'block';
          console.error(err);
        });
      }

      function fmtDateISOtoDisplay(isoDateStr){
        const d = new Date(isoDateStr);
        if(isNaN(d)) return isoDateStr;
        const dd = String(d.getDate()).padStart(2,'0');
        const mmm = d.toLocaleString('en-GB',{month:'short'});
        const yy = String(d.getFullYear()).slice(-2);
        return `${dd}-${mmm}-${yy}`;
      }

      function buildCards(data){
        data.forEach(item=>{
          const auditId = item.audit_id || item['Audit ID'];
          const dateStr = item.date || item.Date;
          const category = item.category || item.Category;
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="meta">
              <div style="flex:1">
                <div class="title">${category || '—'}</div>
                <div class="category">${auditId || '—'}</div>
              </div>
              <div style="text-align:right">
                <div class="badge">${fmtDateISOtoDisplay(dateStr || '')}</div>
              </div>
            </div>
            <div class="countdown" data-target="${dateStr || ''}">Loading timer...</div>
            <div class="editable">
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="err" data-action="error">Error Found</button>
              <button class="noerr" data-action="noError">Error Not Found</button>
            </div>
            </div>
          `;
          card.dataset.auditId = auditId || '';
          card.dataset.category = category || '';
          card.dataset.date = dateStr || '';
          cardsEl.appendChild(card);

          card.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', ()=> sendAction(card, btn.dataset.action));
          });

          const cdEl = card.querySelector('.countdown');
          startCountdown(cdEl, dateStr);
        });
      }

      function startCountdown(el, dateStr){
        let target;
        if(!dateStr) {
          el.textContent = 'No deadline';
          return;
        }
        const parsed = new Date(dateStr);
        if(isNaN(parsed)){
          el.textContent = 'Invalid date';
          return;
        }
        target = new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate(), 19, 0, 0, 0);
        function update(){
          const now = new Date();
          let diff = target - now;
          if(diff <= 0){
            el.textContent = 'Overdue';
            return;
          }
          const days = Math.floor(diff / (1000*60*60*24));
          diff -= days*(1000*60*60*24);
          const hours = Math.floor(diff/(1000*60*60));
          diff -= hours*(1000*60*60);
          const mins = Math.floor(diff/(1000*60));
          diff -= mins*(1000*60);
          const secs = Math.floor(diff/1000);
          const parts = [];
          if(days>0) parts.push(days + 'd');
          parts.push(String(hours).padStart(2,'0') + 'h');
          parts.push(String(mins).padStart(2,'0') + 'm');
          parts.push(String(secs).padStart(2,'0') + 's');
          el.textContent = parts.join(' ');
        }
        update();
        const id = setInterval(update, 1000);
        if(!timers[target]) timers[target] = [];
        timers[target].push(id);
      }

      async function sendAction(cardEl, action){
        const payload = {
          action: action,
          audit_id: cardEl.dataset.auditId,
          category: cardEl.dataset.category
        };

        try {
          await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          alert(`✅ ${action} sent successfully!`);

          // Refresh page after 1 second
          setTimeout(() => location.reload(), 1000);          
          console.log('Action sent:', payload);
        } catch(err){
          console.error('Failed to send action:', err);
        }
      }
      fetchPending();
    })();
  </script>
  <script src="https://ntwoods.github.io/ordertodispatch/js/viewOnly.js"></script>
</body>
</html>
